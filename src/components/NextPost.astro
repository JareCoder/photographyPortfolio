---
import { getCollection } from "astro:content";
import { Image, getImage } from "astro:assets";
import Prose from "./Prose.astro";

export interface Props {
  currentSlug: string;
  collection: string;
}

const { currentSlug, collection } = Astro.props;
const allPosts = await getCollection(collection);

// Filter out the current post and shuffle the remaining posts
const otherPosts = allPosts.filter((post) => post.slug !== currentSlug);
const shuffledPosts = otherPosts.sort(() => Math.random() - 0.5).slice(0, 3);

// Only render the component if there's at least one other post
const shouldRender = otherPosts.length > 0;

const favicon = await getImage({
  src: "https://cdn.erfianugrah.com/ea_favicon.png",
  alt: "favicon",
  width: 400,
  height: 400,
});
---

{
  shouldRender && (
    <Prose>
      <div class="flex justify-center mb-6 mt-20">
        <svg
          class="w-14 h-4 text-gray-700 dark:text-gray-300"
          viewBox="0 0 60 20"
          xmlns="http://www.w3.org/2000/svg"
        >
          <circle cx="10" cy="10" r="6" fill="currentColor" />
          <circle cx="30" cy="10" r="6" fill="currentColor" />
          <circle cx="50" cy="10" r="6" fill="currentColor" />
        </svg>
      </div>
      <div class="mt-4">
        <div id="randomPosts" class="grid grid-cols-1 md:grid-cols-3 gap-4">
          {shuffledPosts.map((post) => (
            <a href={`/${collection}/${post.slug}/`} class="no-underline block">
              <div class="rounded-lg overflow-hidden shadow-md transition-all duration-300 hover:shadow-xl bg-gray-100 dark:bg-[rgb(44,43,47)] h-full flex flex-col group">
                <div class="p-4 flex-grow flex flex-col relative">
                  <div class="absolute inset-0 bg-gray-200 dark:bg-[rgb(54,53,57)] opacity-0 group-hover:opacity-100 transition-opacity duration-300" />
                  <div class="h-48 mb-4 overflow-hidden rounded relative z-10 flex items-center justify-center bg-gray-200 dark:bg-gray-700">
                    {post.data.image ? (
                      <Image
                        src={post.data.image.src}
                        alt={post.data.image.alt || ""}
                        width={640}
                        height={360}
                        class="object-cover w-full h-full transition-all duration-300 group-hover:opacity-90"
                      />
                    ) : (
                      <Image
                        src={favicon.src}
                        alt="Site favicon"
                        width={96}
                        height={96}
                        class="w-24 h-24 transition-all duration-300 group-hover:opacity-90"
                      />
                    )}
                  </div>
                  <h3 class="text-lg font-semibold mb-2 font-overpass-mono text-gray-900 dark:text-[rgb(245,245,245)] relative z-10">
                    {post.data.title}
                  </h3>
                  <p class="text-sm line-clamp-2 font-inconsolata flex-grow text-gray-700 dark:text-[rgb(230,230,230)] relative z-10">
                    {post.data.description}
                  </p>
                </div>
              </div>
            </a>
          ))}
        </div>
      </div>
    </Prose>
  )
}

<script>
  function shuffleArray(array) {
    for (let i = array.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [array[i], array[j]] = [array[j], array[i]];
    }
    return array;
  }

  function updateRandomPosts() {
    const postElements = Array.from(
      document.querySelectorAll("#randomPosts > a"),
    );
    const shuffledElements = shuffleArray(postElements);
    const container = document.getElementById("randomPosts");
    container.innerHTML = "";
    shuffledElements.forEach((element) => container.appendChild(element));
  }

  document.addEventListener("astro:page-load", updateRandomPosts);
</script>
